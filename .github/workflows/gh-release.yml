name: Release

on:
  push:
    tags:
      - "*-v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Get Mod Folder
        id: get-mod-dir
        run: echo "DIR=$(echo ${{ github.ref_name }} | cut -d'-' -f1)" >> $GITHUB_OUTPUT

      - name: Get Version
        id: get-version
        run: echo "VERSION=$(echo ${{ github.ref_name }} | sed 's/^.*-v//')" >> $GITHUB_OUTPUT

      - name: Get auto-generated release notes
        id: generate-notes
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: context.ref.replace('refs/tags/', '')
            });
            return response.data.body;
          result-encoding: string

      - name: Generate changelog
        run: |
          cat << 'NOTESEOF' > CHANGELOG.md
          ${{ steps.generate-notes.outputs.result }}
          NOTESEOF

          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep "^${{ steps.get-mod-dir.outputs.DIR }}-v" | head -n 2 | tail -n 1)

          if [ ! -z "$PREVIOUS_TAG" ]; then
            echo "" >> CHANGELOG.md
            echo "## Commit History" >> CHANGELOG.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse >> CHANGELOG.md
          fi

      - name: Install dotnet
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: 9

      - name: Build
        run: dotnet build ./${{ steps.get-mod-dir.outputs.DIR }}

      - name: Create archive
        run: |
          mkdir -p ${{ steps.get-mod-dir.outputs.DIR }}/bin/Publish
          zip --junk-paths ${{ steps.get-mod-dir.outputs.DIR }}/bin/Publish/${{ github.ref_name }}.zip ${{ steps.get-mod-dir.outputs.DIR }}/bin/Debug/**/* --exclude *.deps.json

          if [[ ${{steps.get-mod-dir.outputs.DIR}} == "Voicelines" ]]; then
            cd Voicelines
            zip ./bin/Publish/${{ github.ref_name }}.zip ./SFX/*.wav
            cd -
          fi

      - name: Release
        uses: softprops/action-gh-release@v2.3.3
        with:
          name: "${{ steps.get-mod-dir.outputs.DIR }} v${{ steps.get-version.outputs.VERSION }}"
          files: ${{ steps.get-mod-dir.outputs.DIR }}/bin/Publish/*.zip
          fail_on_unmatched_files: true
          body_path: CHANGELOG.md
          make_latest: true
